// filepath: serverless/lab/upload-file.ts

import {
  APIGatewayProxyEvent,
  APIGatewayProxyHandler,
  APIGatewayProxyResult,
} from "aws-lambda";

import {
  createHttpResponse,
  errorHttpResponseHandler,
  extractEventBody,
} from "../common/http.helpers.js";

import { S3Client, PutObjectCommand } from "@aws-sdk/client-s3";

const s3 = new S3Client({});

// -----------------------------------------
//   HARD-CODE YOUR S3 BUCKET NAME HERE
// -----------------------------------------
const BUCKET_NAME = "<YOUR_BUCKET_NAME>";

export const uploadFileHandler: APIGatewayProxyHandler = async (
  event: APIGatewayProxyEvent
): Promise<APIGatewayProxyResult> => {
  try {
    const body: any = extractEventBody(event);

    if (!body || !body.fileName || !body.fileContent) {
      return createHttpResponse(
        event,
        400,
        JSON.stringify({
          message: "fileName and fileContent are required",
        })
      );
    }

    const fileBuffer = Buffer.from(body.fileContent, "base64");

    const uploadCommand = new PutObjectCommand({
      Bucket: BUCKET_NAME,
      Key: body.fileName,
      Body: fileBuffer,
      ContentType: "application/pdf",
    });

    await s3.send(uploadCommand);

    return createHttpResponse(
      event,
      200,
      JSON.stringify({
        message: "PDF uploaded successfully",
        file: body.fileName,
        bucket: BUCKET_NAME,
      })
    );
  } catch (err) {
    console.log("Unexpected error:", err);
    return errorHttpResponseHandler(event, err);
  }
};